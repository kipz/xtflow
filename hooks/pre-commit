#!/bin/bash
# Pre-commit hook to run clj-kondo linting

echo "Running clj-kondo..."

# Run clj-kondo on staged Clojure files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(clj|cljs|cljc|edn)$')

if [ -z "$STAGED_FILES" ]; then
    # No Clojure files staged
    exit 0
fi

# Run clj-kondo and capture output
OUTPUT=$(clj-kondo --lint $STAGED_FILES 2>&1)
EXIT_CODE=$?

# Print the output
echo "$OUTPUT"

# Fail if clj-kondo found any issues (even info level)
# clj-kondo outputs "linting took" when successful with no findings
if echo "$OUTPUT" | grep -v "linting took" | grep -E "(warning|error|info):"; then
    echo ""
    echo "❌ clj-kondo found issues. Please fix them before committing."
    echo "   To skip this check, use: git commit --no-verify"
    exit 1
fi

# Also check the exit code for errors/warnings
if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "❌ clj-kondo found issues. Please fix them before committing."
    echo "   To skip this check, use: git commit --no-verify"
    exit 1
fi

echo "✅ clj-kondo passed"
exit 0
